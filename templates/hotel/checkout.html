{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

<!-- Selected Rooms Hero Section -->
<section class="selected_hero" style="background-image: url('{% static "images/booking-hero.jpg" %}');">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="selected_hero_title">Your Selected Rooms</h1>
                <p class="selected_hero_subtitle">Review your selection and complete your booking</p>
            </div>
        </div>
    </div>
</section>

<!-- Selected Rooms Section -->
<section class="selected_rooms_section section_gap selection-list">
    <div class="container">
        <div class="row">
            <!-- Selected Rooms Column -->
            <div class="col-lg-8">
                <div class="selected_rooms_header mb-4">
                    <h3>Your Selected Rooms ({{ booking.rooms }})</h3>
                    <p>You can review or remove rooms before booking</p>
                </div>

                {% for r in booking.room.all %}
                <div class="selected_room_card mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="selected_room_image">
                                <img src="{{ r.room_type.image.url }}" alt="{{ r.room_type.type }}" class="img-fluid">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="selected_room_info">
                                <h4>{{ r.room_type.type }} Room</h4>
                                <div class="room_meta">
                                    <span><i class="fas fa-door-open"></i> Room {{ r.room_type.room_number }}</span>
                                    <span><i class="fas fa-layer-group"></i> Floor {{ r.room_type.floor }}</span>
                                </div>
                                <div class="room_features">
                                    <span><i class="fas fa-user"></i> {{ r.room_type.room_capacity }} Guests</span>
                                    <span><i class="fas fa-bed"></i> {{ r.room_type.number_of_beds }} Beds</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="selected_room_actions d-flex align-items-center justify-content-between">
                                <div class="room_price">
                                    ${{ r.room_type.price }} <small>/ night</small>
                                </div>
                                <button class="btn btn-sm btn-danger remove_room_btn delete-item" data-item="{{id}}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty_selection text-center py-5">
                    <i class="fas fa-hotel fa-3x mb-3"></i>
                    <h4>No rooms selected yet</h4>
                    <p>Browse our rooms and add them to your selection</p>
                    <a href="#" class="btn btn-primary">View Rooms</a>
                </div>
                {% endfor %}

                <!-- Billing Information Form -->
                <div class="billing_information mt-5">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">Billing Information</h3>
                        </div>
                        <div class="card-body">
                            <form id="billingForm" method="POST">
                                {%csrf_token%}
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="fullName">Full Name </label>
                                            <input type="text" name="full_name" class="form-control" id="fullName" value="{{booking.full_name}}" readonly style="background:rgb(227,227,227);" >
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="email">Email Address </label>
                                            <input type="email" name="email" class="form-control" id="email" value="{{booking.email}}"readonly style="background:rgb(227,227,227);">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="phone">Phone Number </label>
                                            <input  type="tel"  name="phone" class="form-control" id="phone" value="{{booking.phone}}" readonly style="background:rgb(227,227,227);">
                                        </div>
                                    </div>
                                    
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Summary Column -->
            <div class="col-lg-4">
                <div class="booking_summary_widget sticky-top">
                    <div class="widget_header">
                        <h3>Booking Summary</h3>
                    </div>
                    <div class="widget_body">
                        <div class="summary_hotel_info mb-4">
                            <h5>{{ booking.hotel.name }}</h5>
                            <div class="hotel_rating mb-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= hotel.rating %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                <span>({{ hotel.review_count }} reviews)</span>
                            </div>
                            <p><i class="fas fa-map-marker-alt"></i> {{ booking.hotel.address }}</p>
                        </div>

                        <div class="summary_dates mb-4">
                            <div class="date_item">
                                <span>Check-in</span>
                                <strong>{{ booking.check_in_date }}</strong>
                            </div>
                            <div class="date_item">
                                <span>Check-out</span>
                                <strong>{{ booking.check_out_date }}</strong>
                            </div>
                            <div class="stay_duration">
                                <span>Total nights:</span>
                                <strong>
                                    {{ booking.total_days }} nights
                                </strong>
                            </div>
                        </div>

                        <div class="summary_guests mb-4">
                            <div class="guests_item">
                                <span>Adults</span>
                                <strong>{{ booking.num_adults }}</strong>
                            </div>
                            <div class="guests_item">
                                <span>Children</span>
                                <strong>{{ booking.num_children }}</strong>
                            </div>
                        </div>

                        <div class="price_breakdown">
                            <div class="price_item">
                                <span>Room Price ({{ booking.rooms }} rooms)</span>
                                <span>${{ booking.before_discount|floatformat:2 }}</span>
                            </div>
                            <div class="price_item">
                                <span>Taxes & Fees</span>
                                <span>{{booking.saved}}</span>
                            </div>
                            <div class="price_total">
                                <span>Total</span>
                                <span>${{ booking.total }}</span>
                            </div>
                        </div>
                    
                        <div class="promo_code mt-4">
                            <h5>Apply Promo Code</h5>
                            <form method="POST">
                            {%csrf_token%}
                            <div class="input-group">
                                <input type="text" class="form-control" name="code" placeholder="Enter promo code">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="submit" style="background-color: rgb(47, 200, 200);">Apply</button>
                                </div>
                            </div>
                            </form>
                        </div>
                        <br>
                        <br>
                        <div id="paypal-button-container"></div>

                       <button type="button"  class="btn btn-block booking_btn mt-4" id="checkout-button" style="background-color: #635bff; border-color: #635bff; color: white;">
                            <i class="fab fa-cc-stripe mr-2" style="font-size: 1.2rem;"></i> Stripe
                        </button>
                        <button type="submit" form="billingForm" class="btn btn-block booking_btn mt-4" >
                            Complete Booking
                        </button>

                        <div class="secure_booking mt-3 text-center">
                            <i class="fas fa-lock"></i>
                            <small>Your booking is secure and encrypted</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Why Book With Us Section -->
<section class="why_book_section section_gap bg-light">
    <div class="container">
        <h2 class="section_title text-center mb-5">Why Book With Us?</h2>
        <div class="row">
            <div class="col-md-4 text-center mb-4">
                <div class="benefit_icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h4>Secure Booking</h4>
                <p>Your personal information is protected with 256-bit encryption.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="benefit_icon">
                    <i class="fas fa-percent"></i>
                </div>
                <h4>Best Price Guarantee</h4>
                <p>Found a better price? We'll match it and give you 10% extra.</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <div class="benefit_icon">
                    <i class="fas fa-headset"></i>
                </div>
                <h4>24/7 Customer Support</h4>
                <p>Our team is available anytime to assist with your booking.</p>
            </div>
        </div>
    </div>
</section>
<script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>


<script>
    let booking_total="{{booking.total}}";
    let booking_id="{{booking.booking_id}}";
    let success_id="{{booking.success_id}}";
    

    paypal.Buttons({
        createOrder:function(data,actions){
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: booking_total
                    }
                }]
            })
        },

        onApprove:function(data,actions){
            return actions.order.capture().then(function(Detail){
                console.log(Detail);
                if(Detail.status ==="COMPLETED"){
                    //Redirect to succes page
                    window.location.href=`/success/${booking_id}/?success=${success_id}&payer_id=${Detail.id}&status=${Detail.status}&booking_total=${booking_total}`;
                }
            })
        }
    }).render("#paypal-button-container")
</script>

<script>
    var stripe=Stripe('{{stripe_publishable_key}}');
    var checkoutButton=document.getElementById("checkout-button");

    checkoutButton.addEventListener("click",function(){
        var email="{{booking.email}}";
        checkoutButton.innerHTML=
        "Processing <i class='fas fa-spinner fa-spin'></i>";
        
        fetch("/api/create_checkout_session/{{booking.booking_id}}/",{
            method:"POST",
            body:JSON.stringify(
                {email:email}
            )
        }).then(function(response){
            console.log(response);
            return response.json();
        }).then(function(session){
            return stripe.redirectToCheckout({sessionId:session.sessionId});
        }).then(function(result){
            if(result.error){
                alert(result.error.messsage);
            }
        })
        .catch(function(error){
            console.log("Error",error);
        });
    });

</script>
{% endblock %}